      } else if (_questionType == 'simulation') {
        final departments = [];
        int totalCorrectBudget = 0;
        for (var dept in _budgetDepartments) {
          final name = dept['nameController']!.text.trim();
          final amountText = dept['amountController']!.text.trim();
          if (name.isEmpty || amountText.isEmpty) {
            ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Please fill all department names and amounts'), backgroundColor: Colors.red));
            setState(() => _isSaving = false);
            return;
          }
          final amount = int.tryParse(amountText);
          if (amount == null || amount < 0) {
            ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text('Invalid amount for $name'), backgroundColor: Colors.red));
            setState(() => _isSaving = false);
            return;
          }
          totalCorrectBudget += amount;
          departments.add({'id': dept['id'], 'name': name, 'correct_amount': amount, 'min': 0, 'max': int.tryParse(_totalBudgetController.text.trim()) ?? 10000});
        }
        final totalBudget = int.tryParse(_totalBudgetController.text.trim()) ?? 10000;
        if (totalCorrectBudget != totalBudget) {
          ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text('Department amounts (\$$totalCorrectBudget) must equal total budget (\$$totalBudget)'), backgroundColor: Colors.red));
          setState(() => _isSaving = false);
          return;
        }
        if (departments.length < 2) {
          ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Please add at least 2 departments'), backgroundColor: Colors.red));
          setState(() => _isSaving = false);
          return;
        }
        questionData['options'] = {'total_budget': totalBudget, 'departments': departments, 'tolerance_percentage': int.tryParse(_toleranceController.text.trim()) ?? 5};
        debugPrint('ðŸ“¤ Budget Simulation: $totalBudget budget, ${departments.length} departments');
